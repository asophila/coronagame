pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
 --agente jugador
 agent={x=64,
        y=64,
        sprt=16,
        risk=0}
 
 -- lista con toda la gente       
 people={}
       
 dx=1
 dy=1
 create_people(30)
end


function _update() 
 move_people()
 check_collision()
 move_agent()
end


function _draw()
 cls(4)
 --gen_map() --genera el mapa
 draw_people()
	draw_agent() --dibuja el agente
end

function draw_agent()
	spr(agent.sprt,agent.x,agent.y)
	if agent.risk>0 then
	 circ(agent.x+3,agent.y+3,10,8)
	else
	 circ(agent.x+3,agent.y+3,10,12)
	end
	agent.risk=0
end

function create_people(cant)
 for p=1,cant do
  person={id=p,
  								x=rnd(120)+4,
  								y=rnd(120)+4,
  								step=rnd(3),
  								dx=rnd(2)-1,
  								dy=rnd(2)-1,
  				    sick=flr(rnd(1.2))}
 add(people,person)
 end
end

function draw_people()
	for p in all(people) do
	 if p.sick==0 then
	  inicio=32
	 else
	  inicio=48
	 end
	 spr(p.step+inicio,p.x,p.y)
	end
end

function check_collision()
 for p in all(people) do
  if (abs(agent.x-p.x)+abs(agent.y-p.y))<16 then
   agent.risk+=1
   on_collision(agent,p)
  end
  for p2 in all(people) do
   if p.id!=p2.id then
    if (abs(p.x-p2.x)+abs(p.y-p2.y))<4 then
     on_collision(p,p2)
    end
   end
  end
 end
end

function on_collision(p1,p2)
 --cambiar direccion del p2
 if (rnd(1)>0.5) p2.dx*=-1 p2.dy*=-1
 if (p1.sick) then 
 	p2.sick=true
 end
end

function move_agent()
 chk=agent.x+(agent.y*128)
 if btn(2) then agent.y-=dy end
 if btn(3) then agent.y+=dy end
 if btn(0) then agent.x-=dx end
 if btn(1) then agent.x+=dx end
 if agent.sprt<19 and
    chk!=agent.x+(agent.y*128) 
    then
  			agent.sprt+=1
 			else agent.sprt=16
 end
end

function move_people()
 for p in all(people) do
  if (p.x<0) or (p.x>128) then
   p.dx*=-1
  end
  if (p.y<0) or (p.y>128) then
   p.dy*=-1
  end
  
  p.x+=p.dx
  p.y+=p.dy
  p.step+=1
  p.step%=4
 end
end

function gen_map()
 --mapa de 9x9
 for room=1,9 do
  draw_room(room)
 end
end

function draw_room(room)
 room-=1
 ancho=10
 r_x=flr(room/3)+1
 r_y=flr(room%3)+1
 
 rect(5+ancho*r_x,5+ancho*r_y,5+ancho*(r_x+1),5+ancho*(r_y+1),2) 
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700007777000077770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700007777000077770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70777707707777077077770770777707000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f00f0000f00f0000f00f0000f00f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f00f000ff00f000ff00ff000f00ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ff00ff000000ff0000000000ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555500005555000055550000555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555500005555000055550000555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555555555555555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f00f0000f00f0000f00f0000f00f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f00f000ff00f000ff00ff000f00ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ff00ff000000ff0000000000ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
37357537735357737737573737757537000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77735373375735333737577373773773000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
35775357777575733375735375335757000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f00f0000f00f0000f00f0000f00f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00f00f000ff00f000ff00ff000f00ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ff00ff000000ff0000000000ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
